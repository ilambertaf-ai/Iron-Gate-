<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Iron Gate</title>

    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + ReactDOM 18 (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>

    <!-- Babel (so we can write JSX in this single file) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide icons (browser bundle provides global `lucide`) -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
      * { -webkit-tap-highlight-color: transparent; }
      input, select { outline: none; }
      /* a tiny bit of fun texture without images */
      .sparkle-bg {
        background-image:
          radial-gradient(circle at 10% 10%, rgba(59,130,246,.18) 0 2px, transparent 3px),
          radial-gradient(circle at 80% 30%, rgba(168,85,247,.16) 0 2px, transparent 3px),
          radial-gradient(circle at 30% 80%, rgba(34,197,94,.14) 0 2px, transparent 3px),
          radial-gradient(circle at 90% 85%, rgba(236,72,153,.12) 0 2px, transparent 3px);
      }
      .glass {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
    </style>
  </head>

  <body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useEffect, useMemo } = React;

      // Tiny Lucide React-style wrapper using lucide's browser bundle
      const Icon = ({ name, size = 24, className = "" }) => (
        <i
          data-lucide={name}
          className={className}
          style={{ width: size, height: size }}
        />
      );

      const FitnessApp = () => {
        const [darkMode, setDarkMode] = useState(false);
        const [currentView, setCurrentView] = useState("calendar");
        const [menuOpen, setMenuOpen] = useState(false);
        const [currentDate, setCurrentDate] = useState(new Date());
        const [selectedDate, setSelectedDate] = useState(null);
        const [calendarData, setCalendarData] = useState({});
        const [showDayModal, setShowDayModal] = useState(false);

        // Modal state for day details
        const [workoutPlan, setWorkoutPlan] = useState([]);
        const [foodEntries, setFoodEntries] = useState([]);
        const [dailyMetrics, setDailyMetrics] = useState({
          weight: "",
          sleep: "",
          water: "",
          calories: "",
        });

        // Persist data
        useEffect(() => {
          try {
            const saved = localStorage.getItem("fitness_calendarData");
            const savedDark = localStorage.getItem("fitness_darkMode");
            if (saved) setCalendarData(JSON.parse(saved));
            if (savedDark) setDarkMode(savedDark === "true");
          } catch (e) {}
        }, []);

        useEffect(() => {
          try {
            localStorage.setItem("fitness_calendarData", JSON.stringify(calendarData));
          } catch (e) {}
        }, [calendarData]);

        useEffect(() => {
          try {
            localStorage.setItem("fitness_darkMode", String(darkMode));
          } catch (e) {}
        }, [darkMode]);

        // Render lucide icons after each render
        useEffect(() => {
          if (window.lucide) window.lucide.createIcons();
        });

        // Close menu on outside click
        useEffect(() => {
          const onClick = (e) => {
            const menu = document.getElementById("menuDropdown");
            const btn = document.getElementById("menuButton");
            if (!menuOpen) return;
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
              setMenuOpen(false);
            }
          };
          document.addEventListener("click", onClick);
          return () => document.removeEventListener("click", onClick);
        }, [menuOpen]);

        const getDaysInMonth = (date) => {
          const year = date.getFullYear();
          const month = date.getMonth();
          const firstDay = new Date(year, month, 1);
          const lastDay = new Date(year, month + 1, 0);
          const daysInMonth = lastDay.getDate();
          const startingDayOfWeek = firstDay.getDay();
          return { daysInMonth, startingDayOfWeek };
        };

        const formatDateKey = (date) => {
          return `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;
        };

        const getCalendarDataForDate = (date) => {
          const key = formatDateKey(date);
          return calendarData[key] || null;
        };

        const handleDateClick = (day) => {
          const clickedDate = new Date(
            currentDate.getFullYear(),
            currentDate.getMonth(),
            day
          );
          setSelectedDate(clickedDate);

          const existingData = getCalendarDataForDate(clickedDate);
          if (existingData) {
            setWorkoutPlan(existingData.workouts || []);
            setFoodEntries(existingData.food || []);
            setDailyMetrics(
              existingData.metrics || { weight: "", sleep: "", water: "", calories: "" }
            );
          } else {
            setWorkoutPlan([]);
            setFoodEntries([]);
            setDailyMetrics({ weight: "", sleep: "", water: "", calories: "" });
          }

          setShowDayModal(true);
        };

        const saveDayData = () => {
          const key = formatDateKey(selectedDate);

          const newData = {
            ...calendarData,
            [key]: {
              workouts: workoutPlan,
              food: foodEntries,
              metrics: dailyMetrics,
              saved: true,
              date: selectedDate.toISOString(),
            },
          };

          setCalendarData(newData);
          setShowDayModal(false);
          alert("Day saved successfully!");
        };

        // ---- Workouts (NOW includes weight) ----
        const addWorkout = () => {
          setWorkoutPlan([...workoutPlan, { exercise: "", sets: "", reps: "", weight: "" }]);
        };

        const updateWorkout = (index, field, value) => {
          const updated = [...workoutPlan];
          updated[index][field] = value;
          setWorkoutPlan(updated);
        };

        const removeWorkout = (index) => {
          setWorkoutPlan(workoutPlan.filter((_, i) => i !== index));
        };

        // ---- Food ----
        const addFood = () => {
          setFoodEntries([...foodEntries, { name: "", calories: "" }]);
        };

        const updateFood = (index, field, value) => {
          const updated = [...foodEntries];
          updated[index][field] = value;
          setFoodEntries(updated);
        };

        const removeFood = (index) => {
          setFoodEntries(foodEntries.filter((_, i) => i !== index));
        };

        // ---- Metrics helpers ----
        const getSavedDays = () =>
          Object.values(calendarData)
            .filter((d) => d && d.saved && d.metrics && d.date)
            .sort((a, b) => new Date(a.date) - new Date(b.date));

        // Accurate averages: only divide by days where that metric exists
        const calculateHealthAverages = () => {
          const savedDays = getSavedDays();
          if (savedDays.length === 0) return { weight: "0", sleep: "0", water: "0", calories: "0" };

          const metricFields = ["weight", "sleep", "water", "calories"];
          const totals = { weight: 0, sleep: 0, water: 0, calories: 0 };
          const counts = { weight: 0, sleep: 0, water: 0, calories: 0 };

          savedDays.forEach((day) => {
            metricFields.forEach((f) => {
              const v = parseFloat(day.metrics?.[f]);
              if (!Number.isNaN(v) && day.metrics?.[f] !== "" && v !== 0) {
                totals[f] += v;
                counts[f] += 1;
              }
            });
          });

          const avg = (field, decimals) => {
            if (!counts[field]) return "0";
            const val = totals[field] / counts[field];
            return val.toFixed(decimals);
          };

          return {
            weight: avg("weight", 1),
            sleep: avg("sleep", 1),
            water: avg("water", 0),
            calories: avg("calories", 0),
          };
        };

        const getMostRecentMetrics = () => {
          const savedDays = getSavedDays().sort((a, b) => new Date(b.date) - new Date(a.date));
          return savedDays.length > 0 ? savedDays[0] : null;
        };

        const getCurrentWeightFromLastEntry = () => {
          const savedDays = getSavedDays().sort((a, b) => new Date(b.date) - new Date(a.date));
          const dayWithWeight = savedDays.find((d) => d.metrics && d.metrics.weight !== "" && !Number.isNaN(parseFloat(d.metrics.weight)));
          return dayWithWeight ? parseFloat(dayWithWeight.metrics.weight) : null;
        };

        // ---- Lifetime Exercise Stats (total reps, total sets, max 1RM weight) ----
        const getLifetimeExerciseStats = () => {
          const stats = {}; // key -> { name, totalSets, totalReps, max1RM, maxAny }

          Object.values(calendarData).forEach((day) => {
            if (!day?.saved || !day?.workouts) return;

            day.workouts.forEach((w) => {
              const nameRaw = (w.exercise || "").trim();
              const key = nameRaw.toLowerCase();
              if (!key) return;

              const sets = parseInt(w.sets, 10) || 0;
              const reps = parseInt(w.reps, 10) || 0;
              const weight = parseFloat(w.weight);
              const weightNum = Number.isNaN(weight) ? null : weight;

              if (!stats[key]) {
                stats[key] = {
                  name: nameRaw,
                  totalSets: 0,
                  totalReps: 0,
                  max1RM: null,
                  maxAny: null,
                };
              }

              stats[key].totalSets += sets;
              stats[key].totalReps += sets * reps;

              // Track max weight used for any entry (fallback)
              if (weightNum !== null) {
                stats[key].maxAny = stats[key].maxAny === null ? weightNum : Math.max(stats[key].maxAny, weightNum);

                // "max weight will only be my one rep max lift" -> only count reps==1 entries for max1RM
                if (reps === 1) {
                  stats[key].max1RM = stats[key].max1RM === null ? weightNum : Math.max(stats[key].max1RM, weightNum);
                }
              }
            });
          });

          // Convert to array and sort by name
          const arr = Object.values(stats).map((s) => ({
            name: s.name,
            totalSets: s.totalSets,
            totalReps: s.totalReps,
            maxWeight: (s.max1RM !== null ? s.max1RM : (s.maxAny ?? 0)),
            is1RMOnly: s.max1RM !== null,
          }));

          arr.sort((a, b) => a.name.localeCompare(b.name));
          return arr;
        };

        // Existing "Top Performance" section: now considers weight as well (optional)
        const getTopExerciseMetrics = () => {
          const exercises = {};
          Object.values(calendarData).forEach((day) => {
            if (day.workouts) {
              day.workouts.forEach((w) => {
                const key = (w.exercise || "").toLowerCase().trim();
                if (!key) return;
                const total = (parseInt(w.sets) || 0) * (parseInt(w.reps) || 0);
                const wt = parseFloat(w.weight);
                const weightNum = Number.isNaN(wt) ? null : wt;

                if (!exercises[key] || total > exercises[key].total) {
                  exercises[key] = {
                    name: w.exercise,
                    sets: w.sets,
                    reps: w.reps,
                    weight: w.weight,
                    total,
                    weightNum,
                  };
                }
              });
            }
          });
          return Object.values(exercises).slice(0, 5);
        };

        const getNextPlannedWorkout = () => {
          const today = new Date();
          const futureDays = Object.entries(calendarData)
            .filter(([_, d]) => d?.date && new Date(d.date) >= today && d.workouts && d.workouts.length > 0)
            .sort(([_, a], [__, b]) => new Date(a.date) - new Date(b.date));

          return futureDays.length > 0 ? futureDays[0][1] : null;
        };

        const renderCalendar = () => {
          const { daysInMonth, startingDayOfWeek } = getDaysInMonth(currentDate);
          const days = [];

          for (let i = 0; i < startingDayOfWeek; i++) {
            days.push(<div key={`empty-${i}`} className="aspect-square" />);
          }

          for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            const hasData = getCalendarDataForDate(date);
            const hasWorkout = !!hasData?.workouts?.length;
            const hasMetrics = !!(hasData?.metrics && (hasData.metrics.weight || hasData.metrics.sleep || hasData.metrics.water || hasData.metrics.calories));

            days.push(
              <div
                key={day}
                onClick={() => handleDateClick(day)}
                className={[
                  "aspect-square flex flex-col items-center justify-center border cursor-pointer transition",
                  "rounded-2xl",
                  darkMode ? "border-white/10 hover:bg-white/5" : "border-black/10 hover:bg-black/5",
                  hasData ? (darkMode ? "bg-white/5" : "bg-black/5") : "",
                ].join(" ")}
              >
                <span className={["text-sm", darkMode ? "text-white" : "text-gray-900"].join(" ")}>
                  {day}
                </span>

                {/* Tiny status pills */}
                <div className="flex gap-1 mt-1">
                  {hasWorkout && <div className="w-2 h-2 rounded-full bg-fuchsia-400" title="Workout" />}
                  {hasMetrics && <div className="w-2 h-2 rounded-full bg-sky-400" title="Metrics" />}
                  {hasData && !hasWorkout && !hasMetrics && <div className="w-2 h-2 rounded-full bg-emerald-400" title="Saved" />}
                </div>
              </div>
            );
          }

          return days;
        };

        // ---- Theme tokens (more modern/fun) ----
        const bgColor = darkMode ? "bg-slate-950" : "bg-slate-50";
        const textColor = darkMode ? "text-slate-100" : "text-slate-900";
        const borderColor = darkMode ? "border-white/10" : "border-black/10";
        const cardBg = darkMode ? "bg-white/5" : "bg-white";
        const cardBorder = darkMode ? "border-white/10" : "border-black/10";

        const headerGradient = darkMode
          ? "bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950"
          : "bg-gradient-to-r from-white via-slate-50 to-white";

        const accentGradient = "bg-gradient-to-r from-sky-500 via-fuchsia-500 to-emerald-500";

        // Memoize some computed stats for performance/consistency
        const lifetimeStats = useMemo(() => getLifetimeExerciseStats(), [calendarData]);
        const currentWeight = useMemo(() => getCurrentWeightFromLastEntry(), [calendarData]);

        return (
          <div className={`min-h-screen ${bgColor} ${textColor} transition-colors sparkle-bg`}>
            {/* Header */}
            <div className={`sticky top-0 z-40 ${headerGradient} glass border-b ${borderColor}`}>
              <div className="flex items-center justify-between p-4">
                {currentView !== "calendar" && (
                  <button
                    onClick={() => setCurrentView("calendar")}
                    className={`p-2 rounded-xl ${darkMode ? "hover:bg-white/10" : "hover:bg-black/5"}`}
                    aria-label="Back"
                  >
                    <Icon name="arrow-left" size={22} />
                  </button>
                )}

                <div className="flex-1">
                  <h1 className="text-xl font-bold tracking-tight">
                    {currentView === "calendar" && "Iron Gate"}
                    {currentView === "health" && "Health Metrics"}
                    {currentView === "exercise" && "Exercise Stats"}
                    {currentView === "data" && "All Data"}
                  </h1>
                  <div className="text-xs opacity-70">
                    {darkMode ? "Night mode: stealth gains üåô" : "Day mode: vitamin D PRs ‚òÄÔ∏è"}
                  </div>
                </div>

                <button
                  id="menuButton"
                  onClick={() => setMenuOpen(!menuOpen)}
                  className={`p-2 rounded-xl ${darkMode ? "hover:bg-white/10" : "hover:bg-black/5"}`}
                  aria-label="Menu"
                >
                  {menuOpen ? <Icon name="x" size={22} /> : <Icon name="menu" size={22} />}
                </button>
              </div>

              {/* subtle accent bar */}
              <div className={`h-1 w-full ${accentGradient} opacity-70`} />
            </div>

            {/* Menu Dropdown */}
            {menuOpen && (
              <div
                id="menuDropdown"
                className={[
                  "fixed right-4 top-16",
                  "w-56 rounded-2xl shadow-xl border",
                  "overflow-hidden",
                  "glass",
                  darkMode ? "bg-slate-900/70 border-white/10" : "bg-white/70 border-black/10",
                  "z-50"
                ].join(" ")}
              >
                {[
                  { key: "health", label: "Health", icon: "activity" },
                  { key: "exercise", label: "Exercise", icon: "dumbbell" },
                  { key: "data", label: "Data", icon: "database" },
                ].map((item) => (
                  <button
                    key={item.key}
                    onClick={() => {
                      setCurrentView(item.key);
                      setMenuOpen(false);
                    }}
                    className={[
                      "w-full text-left px-4 py-3 flex items-center gap-3",
                      darkMode ? "hover:bg-white/10" : "hover:bg-black/5"
                    ].join(" ")}
                  >
                    <span className={`p-2 rounded-xl ${darkMode ? "bg-white/10" : "bg-black/5"}`}>
                      <Icon name={item.icon} size={18} />
                    </span>
                    <span className="font-medium">{item.label}</span>
                  </button>
                ))}

                <div className={`h-px ${darkMode ? "bg-white/10" : "bg-black/10"}`} />

                <button
                  onClick={() => {
                    setDarkMode(!darkMode);
                    setMenuOpen(false);
                  }}
                  className={[
                    "w-full text-left px-4 py-3 flex items-center gap-3",
                    darkMode ? "hover:bg-white/10" : "hover:bg-black/5"
                  ].join(" ")}
                >
                  <span className={`p-2 rounded-xl ${darkMode ? "bg-white/10" : "bg-black/5"}`}>
                    {darkMode ? <Icon name="sun" size={18} /> : <Icon name="moon" size={18} />}
                  </span>
                  <span className="font-medium">{darkMode ? "Light Mode" : "Dark Mode"}</span>
                </button>
              </div>
            )}

            {/* Calendar View */}
            {currentView === "calendar" && (
              <div className="p-4 max-w-3xl mx-auto">
                <div className="flex items-center justify-between mb-4">
                  <button
                    onClick={() =>
                      setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))
                    }
                    className={`p-2 rounded-xl ${darkMode ? "hover:bg-white/10" : "hover:bg-black/5"}`}
                    aria-label="Previous month"
                  >
                    <Icon name="chevron-left" size={22} />
                  </button>

                  <div className="text-center">
                    <h2 className="text-lg font-semibold">
                      {currentDate.toLocaleDateString("en-US", { month: "long", year: "numeric" })}
                    </h2>
                    <div className="text-xs opacity-70">
                      Tap a day to plan workouts + log metrics ‚úçÔ∏è
                    </div>
                  </div>

                  <button
                    onClick={() =>
                      setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))
                    }
                    className={`p-2 rounded-xl ${darkMode ? "hover:bg-white/10" : "hover:bg-black/5"}`}
                    aria-label="Next month"
                  >
                    <Icon name="chevron-right" size={22} />
                  </button>
                </div>

                <div className={`${cardBg} border ${cardBorder} rounded-3xl p-4 shadow-sm`}>
                  <div className="grid grid-cols-7 gap-1 mb-2">
                    {["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"].map((day) => (
                      <div key={day} className="text-center text-xs font-semibold py-2 opacity-70">
                        {day}
                      </div>
                    ))}
                  </div>
                  <div className="grid grid-cols-7 gap-2">{renderCalendar()}</div>
                </div>
              </div>
            )}

            {/* Health View */}
            {currentView === "health" && (
              <div className="p-4 max-w-3xl mx-auto space-y-4">
                <div className={`${cardBg} border ${cardBorder} rounded-3xl p-5 shadow-sm`}>
                  <div className="flex items-center gap-2 mb-3">
                    <span className={`p-2 rounded-2xl ${darkMode ? "bg-white/10" : "bg-black/5"}`}>
                      <Icon name="bar-chart-3" size={18} />
                    </span>
                    <h3 className="font-semibold">Current Averages (only days you actually logged)</h3>
                  </div>

                  {(() => {
                    const avg = calculateHealthAverages();
                    return (
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div className={`rounded-2xl p-3 border ${cardBorder}`}>
                          <div className="opacity-70 text-xs mb-1">Weight</div>
                          <div className="font-semibold">{avg.weight} lbs</div>
                        </div>
                        <div className={`rounded-2xl p-3 border ${cardBorder}`}>
                          <div className="opacity-70 text-xs mb-1">Sleep</div>
                          <div className="font-semibold">{avg.sleep} hrs</div>
                        </div>
                        <div className={`rounded-2xl p-3 border ${cardBorder}`}>
                          <div className="opacity-70 text-xs mb-1">Water</div>
                          <div className="font-semibold">{avg.water} oz</div>
                        </div>
                        <div className={`rounded-2xl p-3 border ${cardBorder}`}>
                          <div className="opacity-70 text-xs mb-1">Calories</div>
                          <div className="font-semibold">{avg.calories}</div>
                        </div>
                      </div>
                    );
                  })()}
                </div>

                <div className={`${cardBg} border ${cardBorder} rounded-3xl p-5 shadow-sm`}>
                  <div className="flex items-center gap-2 mb-3">
                    <span className={`p-2 rounded-2xl ${darkMode ? "bg-white/10" : "bg-black/5"}`}>
                      <Icon name="clock-3" size={18} />
                    </span>
                    <h3 className="font-semibold">Most Recent Entry</h3>
                  </div>

                  {(() => {
                    const recent = getMostRecentMetrics();
                    if (!recent) return <p className="opacity-70 text-sm">No data yet</p>;
                    return (
                      <>
                        <p className="text-xs opacity-70 mb-2">{new Date(recent.date).toLocaleDateString()}</p>
                        <div className="grid grid-cols-2 gap-3 text-sm">
                          <div className={`rounded-2xl p-3 border ${cardBorder}`}>
                            <div className="opacity-70 text-xs mb-1">Weight</div>
                            <div className="font-semibold">{recent.metrics.weight || "‚Äî"} lbs</div>
                          </div>
                          <div className={`rounded-2xl p-3 border ${cardBorder}`}>
                            <div className="opacity-70 text-xs mb-1">Sleep</div>
                            <div className="font-semibold">{recent.metrics.sleep || "‚Äî"} hrs</div>
                          </div>
                          <div className={`rounded-2xl p-3 border ${cardBorder}`}>
                            <div className="opacity-70 text-xs mb-1">Water</div>
                            <div className="font-semibold">{recent.metrics.water || "‚Äî"} oz</div>
                          </div>
                          <div className={`rounded-2xl p-3 border ${cardBorder}`}>
                            <div className="opacity-70 text-xs mb-1">Calories</div>
                            <div className="font-semibold">{recent.metrics.calories || "‚Äî"}</div>
                          </div>
                        </div>
                      </>
                    );
                  })()}
                </div>
              </div>
            )}

            {/* Exercise View */}
            {currentView === "exercise" && (
              <div className="p-4 max-w-3xl mx-auto space-y-4">
                <div className={`${cardBg} border ${cardBorder} rounded-3xl p-5 shadow-sm`}>
                  <div className="flex items-center gap-2 mb-3">
                    <span className={`p-2 rounded-2xl ${darkMode ? "bg-white/10" : "bg-black/5"}`}>
                      <Icon name="calendar-check-2" size={18} />
                    </span>
                    <h3 className="font-semibold">Next Planned Workout</h3>
                  </div>

                  {(() => {
                    const next = getNextPlannedWorkout();
                    if (!next) return <p className="opacity-70 text-sm">No upcoming workouts</p>;
                    return (
                      <>
                        <p className="text-xs opacity-70 mb-2">{new Date(next.date).toLocaleDateString()}</p>
                        {next.workouts.map((w, i) => (
                          <div key={i} className={`mb-2 rounded-2xl p-3 border ${cardBorder} text-sm`}>
                            <div className="font-semibold">{w.exercise || "‚Äî"}</div>
                            <div className="opacity-80">
                              {w.sets || "0"} sets √ó {w.reps || "0"} reps
                              {w.weight ? ` @ ${w.weight} lb` : ""}
                            </div>
                          </div>
                        ))}
                      </>
                    );
                  })()}
                </div>

                <div className={`${cardBg} border ${cardBorder} rounded-3xl p-5 shadow-sm`}>
                  <div className="flex items-center gap-2 mb-3">
                    <span className={`p-2 rounded-2xl ${darkMode ? "bg-white/10" : "bg-black/5"}`}>
                      <Icon name="trophy" size={18} />
                    </span>
                    <h3 className="font-semibold">Top Performance</h3>
                  </div>

                  {getTopExerciseMetrics().length === 0 ? (
                    <p className="opacity-70 text-sm">No exercise data yet</p>
                  ) : (
                    getTopExerciseMetrics().map((ex, i) => (
                      <div key={i} className={`mb-2 rounded-2xl p-3 border ${cardBorder} text-sm`}>
                        <div className="font-semibold">{ex.name}</div>
                        <div className="opacity-80">
                          {ex.sets} sets √ó {ex.reps} reps{ex.weight ? ` @ ${ex.weight} lb` : ""}
                        </div>
                      </div>
                    ))
                  )}
                </div>
              </div>
            )}

            {/* Data View */}
            {currentView === "data" && (
              <div className="p-4 max-w-4xl mx-auto space-y-4">
                {/* Quick Stats */}
                <div className={`${cardBg} border ${cardBorder} rounded-3xl p-5 shadow-sm`}>
                  <div className="flex items-center justify-between gap-3 flex-wrap">
                    <div className="flex items-center gap-2">
                      <span className={`p-2 rounded-2xl ${darkMode ? "bg-white/10" : "bg-black/5"}`}>
                        <Icon name="gauge" size={18} />
                      </span>
                      <div>
                        <div className="font-semibold">Snapshots</div>
                        <div className="text-xs opacity-70">Pulled from your saved entries</div>
                      </div>
                    </div>

                    <div className="flex gap-2 flex-wrap">
                      <div className={`px-3 py-2 rounded-2xl border ${cardBorder} text-sm`}>
                        <span className="opacity-70">Current weight:</span>{" "}
                        <span className="font-semibold">{currentWeight !== null ? `${currentWeight} lbs` : "‚Äî"}</span>
                      </div>
                      {(() => {
                        const avg = calculateHealthAverages();
                        return (
                          <>
                            <div className={`px-3 py-2 rounded-2xl border ${cardBorder} text-sm`}>
                              <span className="opacity-70">Avg sleep:</span>{" "}
                              <span className="font-semibold">{avg.sleep} hrs</span>
                            </div>
                            <div className={`px-3 py-2 rounded-2xl border ${cardBorder} text-sm`}>
                              <span className="opacity-70">Avg water:</span>{" "}
                              <span className="font-semibold">{avg.water} oz</span>
                            </div>
                            <div className={`px-3 py-2 rounded-2xl border ${cardBorder} text-sm`}>
                              <span className="opacity-70">Avg calories:</span>{" "}
                              <span className="font-semibold">{avg.calories}</span>
                            </div>
                          </>
                        );
                      })()}
                    </div>
                  </div>
                </div>

                {/* Lifetime exercise summary */}
                <div className={`${cardBg} border ${cardBorder} rounded-3xl p-5 shadow-sm`}>
                  <div className="flex items-center gap-2 mb-3">
                    <span className={`p-2 rounded-2xl ${darkMode ? "bg-white/10" : "bg-black/5"}`}>
                      <Icon name="list-checks" size={18} />
                    </span>
                    <h3 className="font-semibold">Lifetime Exercise Summary</h3>
                  </div>

                  {lifetimeStats.length === 0 ? (
                    <p className="opacity-70 text-sm">No lifetime exercise data yet. Log workouts on the calendar to build this.</p>
                  ) : (
                    <div className={`overflow-x-auto rounded-2xl border ${cardBorder}`}>
                      <table className="min-w-full text-sm">
                        <thead className={darkMode ? "bg-white/5" : "bg-black/5"}>
                          <tr>
                            <th className="text-left px-4 py-3 font-semibold">Exercise</th>
                            <th className="text-left px-4 py-3 font-semibold">Total reps</th>
                            <th className="text-left px-4 py-3 font-semibold">Total sets</th>
                            <th className="text-left px-4 py-3 font-semibold">Max weight (1RM)</th>
                          </tr>
                        </thead>
                        <tbody>
                          {lifetimeStats.map((s, idx) => (
                            <tr key={idx} className={darkMode ? "border-t border-white/10" : "border-t border-black/10"}>
                              <td className="px-4 py-3 font-medium">{s.name}</td>
                              <td className="px-4 py-3">{s.totalReps}</td>
                              <td className="px-4 py-3">{s.totalSets}</td>
                              <td className="px-4 py-3">
                                {s.maxWeight ? `${s.maxWeight} lb` : "‚Äî"}
                                <span className="text-xs opacity-60 ml-2">
                                  {s.is1RMOnly ? "(from reps=1)" : "(fallback max)"}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  )}
                </div>

                {/* Day-by-day list */}
                <div className="space-y-3">
                  {Object.entries(calendarData)
                    .filter(([_, d]) => d.saved)
                    .sort(([_, a], [__, b]) => new Date(b.date) - new Date(a.date))
                    .map(([key, day]) => (
                      <div key={key} className={`${cardBg} border ${cardBorder} rounded-3xl p-5 shadow-sm`}>
                        <div className="flex items-center justify-between">
                          <h3 className="font-semibold">
                            {new Date(day.date).toLocaleDateString()}
                          </h3>
                          <div className="text-xs opacity-70">
                            {(day.workouts?.length ? "üèãÔ∏è" : "")} {(day.metrics ? "üìà" : "")}
                          </div>
                        </div>

                        {day.workouts && day.workouts.length > 0 && (
                          <div className="mt-3">
                            <p className="text-xs font-semibold opacity-70 mb-2">Workouts</p>
                            <div className="space-y-2">
                              {day.workouts.map((w, i) => (
                                <div key={i} className={`text-sm rounded-2xl p-3 border ${cardBorder}`}>
                                  <div className="font-medium">{w.exercise || "‚Äî"}</div>
                                  <div className="opacity-80">
                                    {w.sets || "0"}√ó{w.reps || "0"}
                                    {w.weight ? ` @ ${w.weight} lb` : ""}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}

                        {day.metrics && (
                          <div className="mt-3">
                            <p className="text-xs font-semibold opacity-70 mb-2">Metrics</p>
                            <div className="text-sm grid grid-cols-2 gap-2">
                              {day.metrics.weight && <div className={`rounded-2xl p-3 border ${cardBorder}`}>Weight: <span className="font-semibold">{day.metrics.weight}</span> lbs</div>}
                              {day.metrics.sleep && <div className={`rounded-2xl p-3 border ${cardBorder}`}>Sleep: <span className="font-semibold">{day.metrics.sleep}</span> hrs</div>}
                              {day.metrics.water && <div className={`rounded-2xl p-3 border ${cardBorder}`}>Water: <span className="font-semibold">{day.metrics.water}</span> oz</div>}
                              {day.metrics.calories && <div className={`rounded-2xl p-3 border ${cardBorder}`}>Calories: <span className="font-semibold">{day.metrics.calories}</span></div>}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}

                  {Object.values(calendarData).filter((d) => d.saved).length === 0 && (
                    <p className="opacity-70">No saved days yet. Tap a day on the calendar and save it.</p>
                  )}
                </div>
              </div>
            )}

            {/* Day Modal */}
            {showDayModal && (
              <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                <div className={`${darkMode ? "bg-slate-950" : "bg-white"} border ${cardBorder} rounded-3xl max-w-md w-full max-h-[90vh] overflow-y-auto p-6 shadow-2xl`}>
                  <div className="flex items-start justify-between gap-3 mb-4">
                    <div>
                      <h2 className="text-xl font-bold">{selectedDate?.toLocaleDateString()}</h2>
                      <p className="text-xs opacity-70">Plan it. Log it. Become hard to kill (metaphorically). üóø</p>
                    </div>
                    <button
                      onClick={() => setShowDayModal(false)}
                      className={`p-2 rounded-2xl ${darkMode ? "hover:bg-white/10" : "hover:bg-black/5"}`}
                      aria-label="Close"
                    >
                      <Icon name="x" size={18} />
                    </button>
                  </div>

                  {/* Workouts */}
                  <div className="mb-6">
                    <div className="flex justify-between items-center mb-2">
                      <h3 className="font-semibold">Workouts</h3>
                      <button
                        onClick={addWorkout}
                        className={`px-3 py-2 rounded-2xl text-sm font-semibold ${darkMode ? "bg-white/10 hover:bg-white/15" : "bg-black/5 hover:bg-black/10"}`}
                      >
                        <span className="inline-flex items-center gap-2">
                          <Icon name="plus" size={16} />
                          Add
                        </span>
                      </button>
                    </div>

                    {workoutPlan.map((workout, i) => (
                      <div key={i} className={`grid grid-cols-12 gap-2 mb-2 p-3 border ${cardBorder} rounded-2xl`}>
                        <input
                          placeholder="Exercise"
                          value={workout.exercise}
                          onChange={(e) => updateWorkout(i, "exercise", e.target.value)}
                          className={`col-span-12 sm:col-span-5 px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                        />
                        <input
                          placeholder="Sets"
                          type="number"
                          value={workout.sets}
                          onChange={(e) => updateWorkout(i, "sets", e.target.value)}
                          className={`col-span-4 sm:col-span-2 px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                        />
                        <input
                          placeholder="Reps"
                          type="number"
                          value={workout.reps}
                          onChange={(e) => updateWorkout(i, "reps", e.target.value)}
                          className={`col-span-4 sm:col-span-2 px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                        />
                        <input
                          placeholder="Weight"
                          type="number"
                          value={workout.weight || ""}
                          onChange={(e) => updateWorkout(i, "weight", e.target.value)}
                          className={`col-span-4 sm:col-span-2 px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                        />
                        <button
                          onClick={() => removeWorkout(i)}
                          className={`col-span-12 sm:col-span-1 px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "hover:bg-white/10" : "hover:bg-black/5"} text-rose-500`}
                          aria-label="Remove workout"
                          title="Remove"
                        >
                          <Icon name="trash-2" size={18} />
                        </button>
                      </div>
                    ))}

                    {workoutPlan.length === 0 && (
                      <p className="text-sm opacity-70">No workouts yet. Add one and feed the logbook.</p>
                    )}
                  </div>

                  {/* Food */}
                  <div className="mb-6">
                    <div className="flex justify-between items-center mb-2">
                      <h3 className="font-semibold">Food & Calories</h3>
                      <button
                        onClick={addFood}
                        className={`px-3 py-2 rounded-2xl text-sm font-semibold ${darkMode ? "bg-white/10 hover:bg-white/15" : "bg-black/5 hover:bg-black/10"}`}
                      >
                        <span className="inline-flex items-center gap-2">
                          <Icon name="plus" size={16} />
                          Add
                        </span>
                      </button>
                    </div>

                    {foodEntries.map((food, i) => (
                      <div key={i} className={`flex gap-2 mb-2 p-3 border ${cardBorder} rounded-2xl`}>
                        <input
                          placeholder="Food item"
                          value={food.name}
                          onChange={(e) => updateFood(i, "name", e.target.value)}
                          className={`flex-1 px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                        />
                        <input
                          placeholder="Cal"
                          type="number"
                          value={food.calories}
                          onChange={(e) => updateFood(i, "calories", e.target.value)}
                          className={`w-24 px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                        />
                        <button
                          onClick={() => removeFood(i)}
                          className={`px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "hover:bg-white/10" : "hover:bg-black/5"} text-rose-500`}
                          aria-label="Remove food"
                          title="Remove"
                        >
                          <Icon name="trash-2" size={18} />
                        </button>
                      </div>
                    ))}

                    {foodEntries.length === 0 && (
                      <p className="text-sm opacity-70">No food entries yet. Add a snack. Or a feast. ü•£</p>
                    )}
                  </div>

                  {/* Daily Metrics */}
                  <div className="mb-6">
                    <h3 className="font-semibold mb-2">Daily Metrics</h3>
                    <div className="space-y-2">
                      <input
                        placeholder="Weight (lbs)"
                        type="number"
                        value={dailyMetrics.weight}
                        onChange={(e) => setDailyMetrics({ ...dailyMetrics, weight: e.target.value })}
                        className={`w-full px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                      />
                      <input
                        placeholder="Sleep (hours)"
                        type="number"
                        value={dailyMetrics.sleep}
                        onChange={(e) => setDailyMetrics({ ...dailyMetrics, sleep: e.target.value })}
                        className={`w-full px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                      />
                      <input
                        placeholder="Water (oz)"
                        type="number"
                        value={dailyMetrics.water}
                        onChange={(e) => setDailyMetrics({ ...dailyMetrics, water: e.target.value })}
                        className={`w-full px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                      />
                      <input
                        placeholder="Total Calories"
                        type="number"
                        value={dailyMetrics.calories}
                        onChange={(e) => setDailyMetrics({ ...dailyMetrics, calories: e.target.value })}
                        className={`w-full px-3 py-2 rounded-2xl border ${cardBorder} ${darkMode ? "bg-white/5" : "bg-white"}`}
                      />
                    </div>
                  </div>

                  {/* Buttons */}
                  <div className="flex gap-3">
                    <button
                      onClick={() => setShowDayModal(false)}
                      className={`flex-1 py-3 rounded-2xl border ${cardBorder} ${darkMode ? "hover:bg-white/10" : "hover:bg-black/5"}`}
                    >
                      Cancel
                    </button>
                    <button
                      onClick={saveDayData}
                      className={`flex-1 py-3 rounded-2xl text-white font-semibold ${accentGradient}`}
                    >
                      Save Day
                    </button>
                  </div>

                  <p className="text-xs opacity-60 mt-3">
                    Tip: For your ‚ÄúMax weight (1RM)‚Äù to be correct, log a set with <span className="font-semibold">reps = 1</span> and the weight you hit.
                  </p>
                </div>
              </div>
            )}
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<FitnessApp />);
    </script>
  </body>
</html>
